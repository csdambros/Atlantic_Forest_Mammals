Comparing dispersal, environmental and mid-domain effects on species distribution
============================

`r rm(list=ls())`

## By CSDambros


>html updated in `r as.character(Sys.time())`

### Load required packages, import auxiliary functions and set default graphical parameters


```{r Loading packages, results='hide',message=FALSE}

require(raster)
require(rgdal)
require(maptools)
require(vegan)
require(mgcv)

source("anetwork.R")
source("MidD.R")
source("simunetwork.R")

Custom.Palette<- colorRampPalette(colors=c('lightblue','yellow','red'),bias=1,space='rgb')
color.select<-function(x){Custom.Palette(101)[1+round(((x-min(x))/diff(range(x)))*100)]}

op<-par(no.readonly=TRUE)
```

### Importing the main data file

```{r Importing data}

mammal.data=read.csv('NC5.csv')# Data from each locality


```


### Importing maps from shapefiles
>The maps must be in a folder called "Shapefiles/" before running the code

```{r Importing maps, results="hide"}

folder<-"Shapefiles/"

brazil<-readShapeSpatial(paste(folder,"BR_Contorno.shp",sep=""))
biomes<-readShapeSpatial(paste(folder,"bioma.shp",sep=""))

```

### Importing data from the WorldClim (automatically download data if necessary)

```{r Importing environmental layers from worldclim, results="hide"}

wclim <- raster::getData("worldclim", var="bio", res=2.5, path="")
wclim.clipped<-crop(wclim,extent(-70,-30,-35,5))
#rm(wclim)


```

### Transform data and extract variables from data sets

```{r Transforming data, results="hide"}

### Calculate the distance from the coast

poly<-(brazil@polygons)[[1]]@Polygons

LAT.coast<-unlist(lapply(poly,function(x){x@coords[,2]}))
LONG.coast<-unlist(lapply(poly,function(x){x@coords[,1]}))
long.chui<--(53+22/60+25/3600)

LONG.coast.east<-LONG.coast[LONG.coast>long.chui]
LAT.coast.east<-LAT.coast[LONG.coast>long.chui]

LONG.matrix.east<-t(matrix(LONG.coast.east,nrow=length(LONG.coast.east),ncol=length(mammal.data$Lat)))
LAT.matrix.east<-t(matrix(LAT.coast.east,nrow=length(LAT.coast.east),ncol=length(mammal.data$Lat)))

Longitude.matrix<-matrix(mammal.data$Long,nrow=length(mammal.data$Lat),ncol=length(LONG.coast.east))
Latitude.matrix<-matrix(mammal.data$Lat,nrow=length(mammal.data$Lat),ncol=length(LONG.coast.east))

LONG.diff<-LONG.matrix.east-Longitude.matrix
LAT.diff<-LAT.matrix.east-Latitude.matrix

Distance.coast.matrix<-sqrt(LONG.diff^2+LAT.diff^2)
mammal.data$Distance.coast<-apply(Distance.coast.matrix,1,min)

mammal.data$Long.closest<-apply(Distance.coast.matrix,1,function(x){LONG.coast.east[x==min(x)]})
mammal.data$Lat.closest<-apply(Distance.coast.matrix,1,function(x){LAT.coast.east[x==min(x)]})

#Grouping the latitude and longitude in 2x2 degrees (create new variables in the dataframe)
mammal.data$Long2<-floor(mammal.data$Long/2)*2+1
mammal.data$Lat2<-floor(mammal.data$Lat/2)*2+1

Longitude.matrix2<-matrix(mammal.data$Long2,nrow=length(mammal.data$Lat2),ncol=length(LONG.coast.east))
Latitude.matrix2<-matrix(mammal.data$Lat2,nrow=length(mammal.data$Lat2),ncol=length(LONG.coast.east))

LONG.diff2<-LONG.matrix.east-Longitude.matrix2
LAT.diff2<-LAT.matrix.east-Latitude.matrix2

Distance.coast.matrix2<-sqrt(LONG.diff2^2+LAT.diff2^2)
mammal.data$Distance.coast2<-apply(Distance.coast.matrix2,1,min)

mammal.data$Long.closest2<-apply(Distance.coast.matrix2,1,function(x){LONG.coast.east[x==min(x)]})
mammal.data$Lat.closest2<-apply(Distance.coast.matrix2,1,function(x){LAT.coast.east[x==min(x)]})

rm(Distance.coast.matrix,LAT.diff,LONG.diff,Longitude.matrix,Latitude.matrix,
   LONG.matrix.east,LAT.matrix.east,LONG.coast.east,LAT.coast.east,LAT.coast,LONG.coast,
   long.chui,poly,Distance.coast.matrix2,LAT.diff2,LONG.diff2,Longitude.matrix2,Latitude.matrix2)

attach(mammal.data)

#mammal.short.PA<-tapply(rep(1,length(LOCALIDADE)),list(LOCALIDADE,ESPECIE),sum)
#mammal.short.PA[is.na(mammal.short.PA)]<-0

#head(mammal.data)

```

### Create a data with the points grouped in 2x2 quadrants

```{r Creating_2x2_degrees_for_the_whole_AF}

AF.Long<-unlist(lapply((biomes[6,]@polygons)[[1]]@Polygons,function(x)x@coords[,1]))
AF.Lat<-unlist(lapply((biomes[6,]@polygons)[[1]]@Polygons,function(x)x@coords[,2]))

AF.Lat2<-ceiling(c(AF.Lat,Lat)/2)*2-1
AF.Long2<-ceiling(c(AF.Long,Long)/2)*2-1

#Create a dataframe with the unique locations representing the AF (the point 53 is an isolated island))
environment.AF.2d<-unique(data.frame(AF.Long2=AF.Long2,AF.Lat2=AF.Lat2))

```

```{r}
# 
#species.2d<-tapply(rep(1,length(Lat2)),list(paste(Long2,Lat2),ESPECIE),sum)
# 
# 
#species.ab<-tapply(ABUNDANCIA,list(LOCALIDADE,ESPECIE),sum)# CAUTION: SOME SPECIES WERE NOT DETECTED IN ANY STUDY RECORDING ABUNDANCE
# locality.species.AB[is.na(locality.species.AB)]<-0
# 
species.ab.loc<-tapply(rep(1,length(Lat)),list(paste(Long,Lat),ESPECIE),sum)
species.ab.loc[is.na(species.ab.loc)]<-0
#dim(species.ab)
#
# 

species.loc <- species.ab.loc
species.loc[species.loc>0]<-1

# 

```

### Summarizing environmental data

``` {r}

environment<-data.frame(unique(cbind(Long,Lat)))
environment<-environment[order(factor(paste(environment[,1],environment[,2]))),]

environment$dist.coast<-tapply(as.numeric(Distance.coast),paste(Long,Lat),mean)
environment$conservation<-tapply(as.numeric(CONSERVACAO),paste(Long,Lat),mean)
environment$vegetation<-tapply(as.numeric(FISIONOMIA),paste(Long,Lat),mean)

###

environment[paste("bio",1:19,sep="")]<-NA

#Take the mean climatic values of four points around the observed area

for(i in 1:nrow(environment)){
  temp.clim<-extract(wclim.clipped,extent(environment[i,1]-.05,environment[i,1]+.05,environment[i,2]-.05,environment[i,2]+.05))
  environment[i,paste("bio",1:19,sep="")]<-colMeans(temp.clim,na.rm=TRUE)}

environment[,paste("PCA.wclim.",1:3,sep="")]<-prcomp(decostand(environment[,paste("bio",1:19,sep="")],"standardize"))$x[,1:3]

# Creating observed statistics

environment$rich<-rowSums(species.loc)
similarity.jac.loc<-vegdist(species.loc,"jaccard")
environment[,paste("pcoa.jac.",1:3,sep="")]<-cmdscale(similarity.jac.loc,k=3)

environment<-data.frame(environment,std=decostand(environment,"standardize"))

```

Regressions of the richness and species composition against the climatic variables

```{r}

summary(step(lm(rich~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment)))

summary(step(lm(pcoa.jac.1~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment)))

summary(step(lm(pcoa.jac.2~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment)))

```

Mantel tests

```{r}

geodist.loc<-dist(environment[,c("Lat","Long")])
envdist.loc<-dist(environment[grep("std",colnames(environment))][3:24])

plot(1-similarity.jac.loc~geodist.loc,col=2)
plot(1-similarity.jac.loc~envdist.loc,col=2)

mantel(similarity.jac.loc,geodist.loc)
mantel(similarity.jac.loc,envdist.loc)

mantel.partial(similarity.jac.loc,geodist.loc,envdist.loc)
mantel.partial(similarity.jac.loc,envdist.loc,geodist.loc)

```


### Summarizing environmental data and groupping species in each quadrant

```{r Summarizing environmental data for each quadrant}

species.2d<-tapply(rep(1,length(Lat2)),list(paste(Long2,Lat2),ESPECIE),sum)
species.2d[is.na(species.2d)]<-0
species.2d[species.2d>0]<-1

environment.2d<-data.frame(unique(cbind(Long2,Lat2)))
environment.2d<-environment.2d[order(factor(paste(environment.2d[,1],environment.2d[,2]))),]

environment.2d$dist.coast<-tapply(as.numeric(Distance.coast2),paste(Long2,Lat2),mean)
environment.2d$conservation<-tapply(as.numeric(CONSERVACAO),paste(Long2,Lat2),mean)
environment.2d$vegetation<-tapply(as.numeric(FISIONOMIA),paste(Long2,Lat2),mean)

# r extracting environmental data from worldclim layers, results="hide"}

environment.2d[paste("bio",1:19,sep="")]<-NA

for(i in 1:nrow(environment.2d)){
  temp.clim<-extract(wclim.clipped,extent(environment.2d[i,1]-1,environment.2d[i,1]+1,environment.2d[i,2]-1,environment.2d[i,2]+1))
  environment.2d[i,paste("bio",1:19,sep="")]<-colMeans(temp.clim,na.rm=TRUE)}

environment.2d[,paste("PCA.wclim.",1:3,sep="")]<-prcomp(decostand(environment.2d[,paste("bio",1:19,sep="")],"standardize"))$x[,1:3]


# Creating observed statistics

environment.2d$rich<-rowSums(species.2d)
similarity.jac<-vegdist(species.2d,"jaccard")
environment.2d[,paste("pcoa.jac.",1:3,sep="")]<-cmdscale(similarity.jac,k=3)

#plot(pcoa.jac.1~Lat2,data=environment.2d)

environment.2d<-data.frame(environment.2d,std=decostand(environment.2d,"standardize"))

environment.2d$matchin.AF.2d<-match(paste(environment.2d[,1],environment.2d[,2]),paste(environment.AF.2d[,1],environment.AF.2d[,2]))

```

Regressions of the richness and species composition against the climatic variables (2d)

```{r}

summary(step(lm(rich~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment.2d)))
summary(step(lm(pcoa.jac.1~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment.2d)))
summary(step(lm(pcoa.jac.2~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment.2d)))

```

Mantel tests

```{r}

geodist.2d<-dist(environment.2d[,c("Lat2","Long2")])
envdist.2d<-dist(environment.2d[grep("std",colnames(environment.2d))][3:24])

plot(1-similarity.jac~geodist.2d,col=2)
plot(1-similarity.jac~envdist.2d,col=2)

mantel(similarity.jac,geodist.2d)
mantel(similarity.jac,envdist.2d)

mantel.partial(similarity.jac,geodist.2d,envdist.2d)
mantel.partial(similarity.jac,envdist.2d,geodist.2d)

```


### Plot a map of the original data and data grouped in quadrants

```{r plotting maps, fig.width=10,fig.height=10,echo=FALSE}


par(xpd=NA)

#par (new=T)

plot(biomes[6,],col='lightblue',border="0",xlim=c(-45,-38))

#plot(subset(wclim.clipped,"bio1"),add=T)
plot(brazil,add=T,lwd=2)
#plot(biomes[6,],add=T,col=adjustcolor(4,alpha=.2),border=0)

rect(environment.AF.2d$AF.Long2-1,environment.AF.2d$AF.Lat2-1,environment.AF.2d$AF.Long2+1,environment.AF.2d$AF.Lat2+1,col=adjustcolor("darkgrey",alpha=.1),border=adjustcolor("darkgrey",alpha=1))

rect(environment.2d$Long2-1,environment.2d$Lat2-1,environment.2d$Long2+1,environment.2d$Lat2+1,col=adjustcolor("green",alpha=.2),border=adjustcolor("darkgrey",alpha=1))
points(mammal.data$Long,mammal.data$Lat,cex=log(ifelse(is.na(AREA..ha.),100,AREA..ha.)+1)/3,pch=21,bg=adjustcolor(2,alpha=.1),col=0)


range.size<-range(log(ifelse(is.na(AREA..ha.),100,AREA..ha.)+1))
divs=5
sizes<-seq(range.size[1]+(diff(range.size)/divs/2),range.size[2]-(diff(range.size)/divs/2),length=divs)

legend(-30,-5, legend=round(exp(sizes)) , pch = 21, col=0,pt.bg=adjustcolor(2,alpha=.5),pt.cex=sizes/3,y.intersp=exp(seq(log(1.2),log(1.5),length=divs)),x.intersp=3,bty="n")

text(-28,-4,"Area (ha)",cex=2)

#points(Long2,Lat2)
#rect(Long2-1,Lat2-1,Long2+1,Lat2+1,col=adjustcolor(3,alpha=.01))


#text(tapply(Long2+1,paste(Lat2,Long2),min),tapply(Lat2+1,paste(Lat2,Long2),min),
#tapply(Lat2,paste(Lat2,Long2),length),font=2)

#text(tapply(Long2+1,paste(Lat2,Long2),min),tapply(Lat2+1,paste(Lat2,Long2),min),
#tapply(AUTOR.E.ANO,paste(Lat2,Long2),function(x)nlevels(factor(as.character(x)))))

#text(environment.2d$Long2,environment.2d$Lat2,rowSums(species.2d))

```



# Running models of species distribution

### There are four different models in this project: Mid Domain, Neutral model (1 and 2), direct effect of environment on species richness and GLMs for each species along environmental gradients

Mid-Domain model
===============

Simulate the range of distribution for each species
-----------------------------

>The model picks one species at a time. Then measures how in how many quadrants the species was present
>Select one quadrant at random and spread the species from there until the number of occupied quadrants equals the original number
>Repeat for all species several times. See the complementary function MidD (in "MidD.R") for details.


* Creating a network (matrix) describing the connectivity between quadrants

>In this model, migration can just occur between quadrants in contact to each other

```{r Connectivity, echo=FALSE}

#Create a matrix of euclidean distances between all pairs of quadrants
dist.AF.2d<-as.matrix(dist(environment.AF.2d[,1:2]))

#Set as 1 the migration rate when the distance is below 4 and above 2 degrees (all adjacent quadrants, including diagonal but not self loops)

connect.AF.2d<-ifelse(dist.AF.2d<4&dist.AF.2d>0,1,0)
connect.2d<-connect.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d]

#rownames(connect.2d)<-1:26


```

```{r plotconnectivity, echo=FALSE, fig.width=16,fig.height=8}

par(mfrow=c(1,2))

plot(brazil,border="darkgrey")
rect(environment.2d$Long2-1,environment.2d$Lat2-1,environment.2d$Long2+1,environment.2d$Lat2+1,border=adjustcolor("darkgrey",alpha=1))

points(environment.2d$Long2,environment.2d$Lat2,pch=21,col=0,bg=2)

nnodes.2d<-nrow(environment.2d)

segments(matrix(environment.2d$Long2,nnodes.2d,nnodes.2d),
         matrix(environment.2d$Lat2,nnodes.2d,nnodes.2d),
         t(matrix(environment.2d$Long2,nnodes.2d,nnodes.2d)),
         t(matrix(environment.2d$Lat2,nnodes.2d,nnodes.2d)),col=connect.2d*2)


par(op)
```

### Run the Mid-Domain model

```{r Mid-Domain, cache=FALSE}

reps=999

MidD.sim<-array(NA,dim=c(nrow(connect.2d),ncol(species.2d),reps))

for(i in 1:reps){
  MidD.sim[,,i]<-MidD(connect.2d,colSums(species.2d),simplify=T)
  }

#### Extracting summary statistics

rich.MidD.vec<-apply(MidD.sim,3,rowSums)

similarity.MidD.vec<-apply(MidD.sim,3,function(mat)as.vector(as.matrix(vegdist(mat,"jaccard"))))


similarity.MidD.mean<-matrix(rowMeans(similarity.MidD.vec),nrow(species.2d),nrow(species.2d))

environment.2d$rich.MidD.mean<-rowMeans(rich.MidD.vec)
environment.2d$rich.MidD.sd<-apply(rich.MidD.vec,1,sd)

similarity.MidD.mean<-matrix(rowMeans(similarity.MidD.vec),nrow(species.2d),nrow(species.2d))
similarity.MidD.sd<-matrix(apply(similarity.MidD.vec,1,sd),nrow(species.2d),nrow(species.2d))

environment.2d[,paste("pcoa.MidD.jac.",1:3,sep="")]<-(
  prcomp(similarity.MidD.mean)$x)[,1:3]

#plot(pcoa.jac.1~pcoa.MidD.jac.1,data=environment.2d)

```

### Plot species diversity (Richness; A) and species composition (B) predicted by the Mid-Domain model 

>Areas with similar colors in B represent areas with similar composition of species


```{r ,fig.width=18,fig.height=9,echo=FALSE}

par(mfrow=c(1,2))

plot(brazil)
rect(environment.2d$Long2-1,environment.2d$Lat2-1,environment.2d$Long2+1,environment.2d$Lat2+1,
     col=adjustcolor(color.select(environment.2d$rich.MidD.mean),alpha=.8))
title("A)",cex=3,adj=0)


plot(brazil)
rect(environment.2d$Long2-1,environment.2d$Lat2-1,environment.2d$Long2+1,environment.2d$Lat2+1,
     col=adjustcolor(color.select(environment.2d$pcoa.MidD.jac.1),alpha=.8))
title("B)",cex=3,adj=0)

par(op)
```


Neutral model
===============
>based in Economo and Keitt (2008)

>This model spreads a given number of individuals (*N*) in each quadrant. Initially all individuals in all quadrants are from a single species. Then the model is run for several generations. In each generation all individuals reproduce and die. Based on the parameters *v* and *m*, the indviduals in the offspring can speciate (point speciation) and migrate. In a single quadrant, two individuals can be from the same species if none of them have speciated with rate *v* in the previous generation, AND if they had the same parent or different parents from the same species, either from the same quadrant or not (none, one or both have migrated). Eventually the diversity within and between quadrants reach a steady-state. At this point the model stops. See the complementary function anetwork (in "anetwork.R") for details. This function actually does not simulate the whole process described here, but instead uses a method borrowed from the coalescent theory of population genetics. See Neutral model 2 for a real simulation which gives the same results.


```{r plot.connectivity, echo=FALSE, fig.width=16,fig.height=8}

par(mfrow=c(1,2))

plot(brazil,border="darkgrey")
rect(environment.AF.2d$AF.Long2-1,environment.AF.2d$AF.Lat2-1,environment.AF.2d$AF.Long2+1,environment.AF.2d$AF.Lat2+1,border=adjustcolor("darkgrey",alpha=1))

points(environment.AF.2d$AF.Long2,environment.AF.2d$AF.Lat2,pch=21,col=0,bg=2)

nnodes.AF.2d<-nrow(environment.AF.2d)

segments(matrix(environment.AF.2d$AF.Long2,nnodes.AF.2d,nnodes.AF.2d),
         matrix(environment.AF.2d$AF.Lat2,nnodes.AF.2d,nnodes.AF.2d),
         t(matrix(environment.AF.2d$AF.Long2,nnodes.AF.2d,nnodes.AF.2d)),
         t(matrix(environment.AF.2d$AF.Lat2,nnodes.AF.2d,nnodes.AF.2d)),col=connect.AF.2d*2)

par(op)
```

### This code optimizes the migration (*m*) and speciation (*v*) (single) parameters in order to better fit the species composition change in the observed data.

>In other words: the model runs hundreds of times for thousands of generations until the best combination of *m* and *v* is reached.
>This procedure is analogue to fit a regression line in a linear regression (when using Maximum Likelihood).

```{r Optimization, cache=TRUE, results='hide',fig.show='hide'}

#Set initial parameters

m=0.01790858  #migration rate
v=0.0017789240  #speciation rate
N=100 #Number of individuals in each node

#Create migration matrix (the sum of all migration rates in a node equals 1)
#M<-connect.AF.2d*(m/rowSums(connect.AF.2d))
#M[is.na(M)]<-0

#diag(M)<-1-(rowSums(M)-diag(M))

#rowSums(M)

#neutral.AF<-anetwork(N,M,v)
#F1=neutral.AF$finalF

#environment.AF.2d$Hill<-1/(diag(neutral.AF$finalF))
#morisita.AF.2d<-extractMH(neutral.AF$finalF)


optimized<-optim(c(m,v),lower=0.001,upper=0.999,method="L-BFGS-B",function(x){

M<-connect.AF.2d*(x[1]/rowSums(connect.AF.2d))
M[is.na(M)]<-0

diag(M)<-1-(rowSums(M)-diag(M))

#rowSums(M)

neutral.AF<-anetwork(N,M,x[2],nruns=1000)
F1=neutral.AF$finalF

morisita.AF.2d<-extractMH(neutral.AF$finalF)

sum((decostand(prcomp(morisita.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d])$x[,1],'range')-
decostand(environment.2d$pcoa.jac.1,'range'))^2)

})


```

### Uses the optimized parameters to recreate the neutral simulation (run one more time)

```{r}
m<-optimized$par[1]
v<-optimized$par[2]

M<-connect.AF.2d*(m/rowSums(connect.AF.2d))
M[is.na(M)]<-0

diag(M)<-1-(rowSums(M)-diag(M))

#rowSums(M)

neutral.AF<-anetwork(N,M,v)
F1=neutral.AF$finalF

environment.AF.2d$Hill<-1/(diag(neutral.AF$finalF))
morisita.AF.2d<-extractMH(neutral.AF$finalF)

environment.AF.2d[,paste("pcoa.mor.AF",1:3,sep="")]<-prcomp((morisita.AF.2d))$x[,1:3]
environment.AF.2d[,paste("pcoa.mor.",1:3,sep="")]<-environment.AF.2d[,paste("pcoa.mor.AF",1:3,sep="")]*NA

environment.AF.2d[environment.2d$matchin.AF.2d,paste("pcoa.mor.",1:3,sep="")]<-#PCA.AF[,1:3]
  prcomp(morisita.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d])$x[,1:3]

#plot(environment.2d$Lat2,decostand(environment.2d$pcoa.jac.1,'range'),bg="gold",pch=22)
#points((environment.AF.2d$AF.Lat2),decostand(environment.AF.2d$pcoa.mor.1,'range',na.rm=T),bg=1,pch=21)
#points(environment.2d$Lat2,decostand(environment.2d$pcoa.MidD.jac.1,'range'),bg=2,pch=23)

#plot(decostand(prcomp(morisita.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d])$x[,1],'range'),decostand(environment.2d$pcoa.jac.1,'range'))

```


Neutral model 2
===============
>based simulation of individuals (takes more than 3 hours to run in a regular computer)

```{r neutral_theory_real_simulation}


N<-matrix(N,nrow(M))

if(file.exists("resu.simu10k.txt")){
  
  neutral.sim.ind<- read.table("resu.simu10k.txt",header=TRUE)
  
  }else{
    
    #m=0.01790858  #migration rate
    #v=0.0017789240  #speciation rate
    #N=100 #Number of individuals in each node
    
    reps2<-10000
    initbuffer<-10000
    
    sp.abund2<-simunetwork(N,M,v,nruns=initbuffer,simplify=FALSE)
    
    neutral.sim.ind<-matrix(NA,sum(N),reps2)
    
    for(rep in 1:reps2){
      
      sp.abund2<-simunetwork(N,M,v,nruns=300,simplify=FALSE,sp.abund=sp.abund2)
      
      neutral.sim.ind[,rep]<-sp.abund2
      
      #print(rep)
      }
    
    write.table(neutral.sim.ind,file="neutral.sim.ind10k.txt")
    
    #tapply(rep(1,sum(N)),list(rep(1:length(N),N),neutral.sim.ind[,1]),sum)
    
    }



```


```{r Calculating_statistics_from_neutral_real_simu}


similarity.neutral.total<-array(NA,dim=c(nrow(environment.AF.2d),nrow(environment.AF.2d),ncol(neutral.sim.ind)))
similarity.neutral.jac.total<-array(NA,dim=c(nrow(environment.AF.2d),nrow(environment.AF.2d),ncol(neutral.sim.ind)))
similarity.neutral<-array(NA,dim=c(nrow(environment.2d),nrow(environment.2d),ncol(neutral.sim.ind)))
similarity.neutral.jac<-array(NA,dim=c(nrow(environment.2d),nrow(environment.2d),ncol(neutral.sim.ind)))
hill.neutral<-matrix(NA,nrow(environment.AF.2d),ncol(neutral.sim.ind))
rich.neutral<-matrix(NA,nrow(environment.AF.2d),ncol(neutral.sim.ind))

for(i in 1:ncol(neutral.sim.ind)){
  
  ver<-tapply(rep(1,sum(N)),list(rep(1:length(N),N),neutral.sim.ind[,i]),sum)
  ver[is.na(ver)]<-0
  
  similarity.neutral.total[,,i]<-as.matrix(vegdist(ver,"morisita"))
  similarity.neutral.jac.total[,,i]<-as.matrix(vegdist(ver,"jaccard"))
  
  similarity.neutral[,,i]<-as.matrix(vegdist(ver,"morisita"))[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d]
  similarity.neutral.jac[,,i]<-as.matrix(vegdist(ver,"jaccard"))[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d]
  
  hill.neutral[,i]<-(1/(rowSums((ver/rowSums(ver))^2)*(rowSums(ver)-1)/(rowSums(ver))))
  rich.neutral[,i]<-rowSums(ver>0)
  }


environment.AF.2d$rich.neutral.mean<-rowMeans(rich.neutral)
environment.AF.2d$rich.neutral.sd<-apply(rich.neutral,1,sd)

environment.AF.2d$hill.neutral.mean<-rowMeans(hill.neutral)
environment.AF.2d$hill.neutral.sd<-apply(hill.neutral,1,sd)

environment.AF.2d[,paste("pcoa.mor.neutral.total.",1:3,sep="")]<-environment.AF.2d[,paste("pcoa.mor.AF",1:3,sep="")]*NA

environment.AF.2d[,paste("pcoa.jac.neutral.total.",1:3,sep="")]<-environment.AF.2d[,paste("pcoa.mor.AF",1:3,sep="")]*NA

environment.AF.2d[,paste("pcoa.mor.neutral.",1:3,sep="")]<-environment.AF.2d[,paste("pcoa.mor.AF",1:3,sep="")]*NA

environment.AF.2d[,paste("pcoa.jac.neutral.",1:3,sep="")]<-environment.AF.2d[,paste("pcoa.mor.AF",1:3,sep="")]*NA


environment.AF.2d[,paste("pcoa.mor.neutral.total.",1:3,sep="")]<-#PCA.AF[,1:3]
  prcomp(apply(similarity.neutral.total[,,round(.6*ncol(neutral.sim.ind)):ncol(neutral.sim.ind)],2,function(x)rowMeans(x)))$x[,1:3]

environment.AF.2d[,paste("pcoa.jac.neutral.total.",1:3,sep="")]<-#PCA.AF[,1:3]
  -prcomp(apply(similarity.neutral.jac.total[,,round(.6*ncol(neutral.sim.ind)):ncol(neutral.sim.ind)],2,function(x)rowMeans(x)))$x[,1:3]

similarity.neutral.mean<-apply(similarity.neutral[,,round(.6*ncol(neutral.sim.ind)):ncol(neutral.sim.ind)],2,function(x)rowMeans(x))

environment.AF.2d[environment.2d$matchin.AF.2d,paste("pcoa.mor.neutral.",1:3,sep="")]<-#PCA.AF[,1:3]
  prcomp(similarity.neutral.mean)$x[,1:3]

similarity.neutral.jac.mean<-apply(similarity.neutral.jac[,,round(.6*ncol(neutral.sim.ind)):ncol(neutral.sim.ind)],2,function(x)rowMeans(x))

environment.AF.2d[environment.2d$matchin.AF.2d,paste("pcoa.jac.neutral.",1:3,sep="")]<-#PCA.AF[,1:3]
  -prcomp(similarity.neutral.jac.mean)$x[,1:3]

#cor(environment.AF.2d$pcoa.mor.1,environment.AF.2d$pcoa.mor.neutral.1,use="c")


```

### Plot species diversity (Richness; A) and species composition (B) predicted by the Neutral Model (2nd) 

>Areas with similar colors in B represent areas with similar composition of species


```{r ,fig.width=18,fig.height=9,echo=FALSE}

par(mfrow=c(1,2))

plot(brazil)
rect(environment.AF.2d$AF.Long2-1,environment.AF.2d$AF.Lat2-1,environment.AF.2d$AF.Long2+1,environment.AF.2d$AF.Lat2+1,
     col=adjustcolor(color.select(environment.AF.2d$rich.neutral.mean),alpha=.8))
title("A)",cex=3,adj=0)


plot(brazil)
rect(environment.AF.2d$AF.Long2-1,environment.AF.2d$AF.Lat2-1,environment.AF.2d$AF.Long2+1,environment.AF.2d$AF.Lat2+1,
     col=adjustcolor(color.select(environment.AF.2d$pcoa.jac.neutral.total.1),alpha=.8))
title("B)",cex=3,adj=0)

par(op)
```

### Comparison of the species composition observed and predicted by the Mid Domain and Neutral (x2) models along the Latitudinal gradient

>The Latitudinal gradient is one of the best known gradients to affect the species diversity in the area.

```{r, fig.width=16,fig.height=8}

par(mfrow=c(1,2))

plot(environment.2d$Lat2,decostand(environment.2d$pcoa.jac.1,'range'),bg="gold",pch=22)

points(environment.2d$Lat2,decostand(environment.2d$pcoa.MidD.jac.1,'range'),bg=2,pch=23)

points((environment.AF.2d$AF.Lat2),decostand(environment.AF.2d$pcoa.mor.1,'range',na.rm=T),bg=4,pch=24)

points((environment.AF.2d$AF.Lat2),decostand(environment.AF.2d$pcoa.mor.neutral.1,'range',na.rm=T),bg=1,pch=3,cex=2)

plot.new()

legend("topleft",c("Observed","MidD","Neutral-ana","Neutral-simu"),pch=c(22,23,24,3),pt.bg=c("gold",2,4,3),bty="n",y.intersp=1.2,cex=2)

#plot(decostand(environment.AF.2d$pcoa.mor.1,'range',na.rm=T),decostand(environment.AF.2d$pcoa.mor.neutral.1,'range',na.rm=T),bg=1,pch=3,cex=2)
#plot(environment.AF.2d$pcoa.mor.1,environment.AF.2d$pcoa.mor.neutral.1,bg=1,pch=3,cex=2)

```

Using GLMs to estimate the probability of each species occurring along each environmental gradient
==================================

>Based on these coefficients, calculates 
>> The expected number of species in each quadrant  
>> The probability of two individuals being from different species (PIE)  
>> The morisita-horn index of species similarity  

> Calculates the glm coefficients (slope and intercept) for each species
> glm.results gives the glm results (with p values) for all species
> glm.coef gives just the coefficients for each species and variable the other variables are meaningless and are necessary just to create the others

```{r using_sdm-logistic_regression_of_each_species, warning=FALSE}

glm.results.2d<-list()
bysp.glm.results.2d<-list()

glm.coef.2d<-list()
bysp.glm.coef.2d<-matrix(NA,ncol(species.2d),2,dimnames=list(colnames(species.2d),c('a','b')))

glm.variables.2d<-c("Long2","Lat2","conservation","vegetation",paste("bio",1:19,sep=""),"PCA.wclim.1","PCA.wclim.2")

for(k in glm.variables.2d){
  for(i in colnames(species.2d)){
    
    bysp.glm.results.2d[[i]]<-glm(as.formula(paste('species.2d[,i]~',paste(k))),family=binomial,data=environment.2d)
    bysp.glm.coef.2d[i,]<-coefficients(bysp.glm.results.2d[[i]])
    
    }
  glm.coef.2d[[k]]<-list(bysp.glm.coef.2d,environment.2d[k])
  }


################################
#Estimate the probability of occurrence for each species in each site given the environmental variables

probs.2d<-lapply(glm.coef.2d,function(x){(exp(x[[1]][,1]+x[[1]][,2]%*%t(x[[2]])))/(1+exp(x[[1]][,1]+x[[1]][,2]%*%t(x[[2]])))}) 

#plot(species.2d[,22]~unlist(glm.coef.2d[[2]][[2]]),type="n")

#for(i in 1:64){
#points(probs.2d[[2]][i,]~unlist(glm.coef.2d[[2]][[2]]),pch=21,bg=2,type="l")
#}

#plot(colSums(probs.2d[[2]])~unlist(glm.coef.2d[[2]][[2]]))


################################

Hill.logis<-data.frame(Hill.logis=lapply(probs.2d,function(x)1/(1-(colSums((x/colSums(x))^2)))))
rich.logis<-data.frame(rich.logis=lapply(probs.2d,function(x)colSums(x)))

environment.AF.2d[,as.character(colnames(Hill.logis))]<-NA
environment.AF.2d[,as.character(colnames(rich.logis))]<-NA

environment.AF.2d[environment.2d$matchin.AF.2d,colnames(Hill.logis)]<-Hill.logis
environment.AF.2d[environment.2d$matchin.AF.2d,colnames(rich.logis)]<-rich.logis

```

#### Simulate the distribution of individuals using the probabilities and then extract the jaccard index

```{r species_similarity_in_sdms}

reps=999

similarity.logis.jac<-array(NA,dim=c(nrow(environment.2d),nrow(environment.2d),reps))

#dim(similarity.logis.jac)
# 
# for(j in glm.variables.2d){
#   
# #  j=glm.variables.2d[[25]]
#   
#  
#   for(k in 1:reps){
# 
#   species.2d.logis<-species.2d*0
# 
#     for(i in 1:nrow(species.2d.logis)){
#       species.2d.logis[i,sample(ncol(species.2d.logis),sum(species.2d[i,]),prob=probs.2d[[j]][,i])] <- 1
#       }
#     similarity.logis.jac[,,k]<-as.matrix(vegdist(species.2d.logis,"jaccard"))
#     }
#   
#   environment.AF.2d[,paste("pcoa.logis.jac.",j,".",1:3,sep="")]<-NA
#   
#   environment.AF.2d[environment.2d$matchin.AF.2d,paste("pcoa.logis.jac.",j,".",1:3,sep="")]<-
#     prcomp(apply(similarity.logis.jac,2,rowMeans))$x[,1:3]
#   
#   }
# 

species.2d.logis.ls<-list()
similarity.logis.jac.ls<-list()
  
for(j in glm.variables.2d){
  
#  j=glm.variables.2d[[25]]
 
  species.2d.logis.reps<-list()
  
  for(k in 1:reps){

  species.2d.logis<-species.2d*0

    for(i in 1:ncol(species.2d.logis)){
      
      species.2d.logis[sample(nrow(species.2d.logis),sum(species.2d[,i]),prob=probs.2d[[j]][i,]),i]<-1
      
      }
    
    similarity.logis.jac[,,k]<-as.matrix(vegdist(species.2d.logis,"jaccard"))
    species.2d.logis.reps[[k]]<-species.2d.logis

    }
  
  similarity.logis.jac.ls[[j]]<-similarity.logis.jac
  species.2d.logis.ls[[j]]<-species.2d.logis.reps
    
  environment.AF.2d[,paste("pcoa.logis.jac.",j,".",1:3,sep="")]<-NA
  
  environment.AF.2d[environment.2d$matchin.AF.2d,paste("pcoa.logis.jac.",j,".",1:3,sep="")]<-
    prcomp(apply(similarity.logis.jac,2,rowMeans))$x[,1:3]
  
  }


```

### Species diversity (Hill numbers and Richness) along environmental gradients predicted by the SDMs

```{r plot_sdms,fig.align='center',fig.width=16,fig.height=16}

par(op)
par(mgp=c(.2,0,0))
par(mar=c(2,2,0,0))

par(mfrow=c(ceiling(length(Hill.logis)/ceiling(sqrt(length(Hill.logis)))),ceiling(sqrt(length(Hill.logis)))))
for (i in glm.variables.2d){plot(Hill.logis[[paste("Hill.logis.",i,sep="")]]~environment.2d[[i]],pch=21,bg=color.select(Hill.logis[[paste("Hill.logis.",i,sep="")]]),xlab=i,ylab="Diversity",axes=FALSE);box()}

par(mfrow=c(ceiling(length(rich.logis)/ceiling(sqrt(length(rich.logis)))),ceiling(sqrt(length(rich.logis)))))

for (i in glm.variables.2d) {

ver<- do.call(cbind,lapply(species.2d.logis.ls[[i]],rowSums))

plot(rowSums(species.2d)~environment.2d[[i]],xlab=i,ylab="Diversity",axes=FALSE,ylim=c(0,max(rowSums(species.2d))),pch=21,col=0,bg="dark grey")  
  
points(rowMeans(ver)~environment.2d[[i]],xlab=i,ylab="Diversity",axes=FALSE,ylim=c(0,max(rowSums(species.2d))),pch=21,col=0,bg=1)  
  
points(rich.logis[[paste("rich.logis.",i,sep="")]]~environment.2d[[i]],pch=21,bg=color.select(rich.logis[[paste("rich.logis.",i,sep="")]]))
  
  box()

  }

```

### Species diversity (Hill numbers and Richness) plotted in the map as predicted by the SDMs of each environmental gradient

```{r}
################################
# Plotting the diversity predictions on the map

attach(environment.2d)

par(mfrow=c(ceiling(length(Hill.logis)/ceiling(sqrt(length(Hill.logis)))),ceiling(sqrt(length(Hill.logis)))),mar=c(0,0,0,0))
for (i in glm.variables.2d){
  plot(brazil)
  title(main=i,line=-3)
  points(Long2,Lat2,pch=22,bg='darkgrey',col=0,cex=.5)
  rect(Long2-1,Lat2-1,Long2+1,Lat2+1,col=color.select(Hill.logis[[paste("Hill.logis.",i,sep="")]]))
  plot(brazil,add=T)
  }


par(mfrow=c(ceiling(length(rich.logis)/ceiling(sqrt(length(rich.logis)))),ceiling(sqrt(length(rich.logis)))),mar=c(0,0,0,0))
for (i in glm.variables.2d){
  plot(brazil)
  title(main=i,line=-3)
  points(Long2,Lat2,pch=22,bg='darkgrey',col=0,cex=.5)
  rect(Long2-1,Lat2-1,Long2+1,Lat2+1,col=color.select(rich.logis[[paste("rich.logis.",i,sep="")]]))
  plot(brazil,add=T)
  }

detach(environment.2d)

```

```{r binding_all_data_frames}

environment.AF.2d[,colnames(environment.2d)]<-NA
environment.AF.2d[environment.2d$match,colnames(environment.2d)]<-environment.2d
```


```{r}

MR1.1<-step(lm(rich~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment.AF.2d))

MR1.1<-(lm(rich~1,data=environment.AF.2d))

summary(MR1.2<-update(MR1.1,~.+rich.neutral.mean))
summary(MR1.3<-update(MR1.1,~.+rich.MidD.mean))

AIC(MR1.1,MR1.2,MR1.3)

summary(MC1.1<-step(lm(pcoa.jac.1~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment.AF.2d)))

summary(MC1.2<-update(MC1.1,~.+pcoa.jac.neutral.1))
summary(MC1.3<-update(MC1.1,~.+pcoa.MidD.jac.1))

summary(MC1.4<-update(MC1.1,~pcoa.jac.neutral.1))
summary(MC1.5<-update(MC1.1,~pcoa.MidD.jac.1))

AIC(MC1.1,MC1.2,MC1.3,MC1.4,MC1.5)

summary(MC2.1<-step(lm(pcoa.jac.2~std.dist.coast+std.conservation+std.vegetation+std.PCA.wclim.1+std.PCA.wclim.2,data=environment.AF.2d)))

summary(MC2.2<-update(MC2.1,~.+pcoa.jac.neutral.2))
summary(MC2.3<-update(MC2.1,~.+pcoa.MidD.jac.2))

AIC(MC2.1,MC2.2,MC2.3)


```



Comparing the models fit
========================

> For this step I calculated the Mean Square Error of each model as described in Gotelli et al. 2009
> The mean square error combines the measurement of precision and bias of the model


### Species Richness

#### Using the raw environmental data as predictors

>Long was excluded for being strongly correlated to Lat

```{r}
summary(step(lm(rich~.,data=environment.AF.2d[,c("rich","Lat2","conservation","vegetation","PCA.wclim.1","PCA.wclim.2")])))
```

#### Using the environmental data as predictors of individual species (in a logistic regression)

>The individual environmental variables were regressed against each species. This generated a probability of a given species to occur in a given site taking into account just one variable. The sum of the probability for all species is the expected species richness in a site. The following code shows how the expected richness given the environmental variables in a logistic regression match the observed richness.

>This code needs to be modified (include logistic prediction as the fitted)

```{r}
summary(step(lm(rich~.,data=environment.AF.2d[,c("rich",paste("rich.logis.",c("Lat2","conservation","vegetation","PCA.wclim.1","PCA.wclim.2"),sep=""))])))

```

### Neutral model

```{r}

summary(lm(rich~rich.neutral.mean,data=environment.AF.2d))

```

### Mid-Domain


```{r}

summary(step(lm(rich~rich.MidD.mean,data=environment.2d)))


```

### Figures comparing the models

```{r comparisons of the models}

#Environment

vars<-c("Lat2","Long2","conservation","vegetation",paste("bio",1:19,sep=""),"PCA.wclim.1","PCA.wclim.2")

par(mgp=c(.2,0,0))
par(mar=c(2,2,0,0))
par(mfrow=c(ceiling(length(vars)/ceiling(sqrt(length(vars)))),ceiling(sqrt(length(vars)))))

# for (i in vars){
#   plot(as.formula(paste("rich~",i)),data=environment.AF.2d[!is.na(environment.AF.2d$bio19),],axes=FALSE)
#   lines(smooth.spline(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),i],environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),paste("rich.logis.",i,sep="")],nknots=5),lwd=2,col=4)
#   lines(smooth.spline(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),i],environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),paste("rich",sep="")],nknots=5),lwd=2,col=2)
#   #points(environment.AF.2d[,i],environment.AF.2d[,paste("rich.logis.",i,sep="")],pch=21,cex=.2,bg=4,col=0)
#   box()
#   #abline(lm(as.formula(paste("rich~",i)),data=environment.AF.2d))
#   }


for (i in vars){
  plot(as.formula(paste("rich~",i)),data=environment.AF.2d[!is.na(environment.AF.2d$bio19),],axes=FALSE)
  abline(lm(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),paste("rich",sep="")]~environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),i]),lwd=2,col=2)
  abline(lm(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),paste("rich.logis.",i,sep="")]~environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),i]),lwd=2,col=4)
  points(environment.AF.2d[,i],environment.AF.2d[,paste("rich.logis.",i,sep="")],pch=21,bg=2,col=0)
  box()
  #abline(lm(as.formula(paste("rich~",i)),data=environment.AF.2d))
  }

# Neutral

par(op)
plot(rich~rich.neutral.mean,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],pch=21,col=NULL,bg=4)
abline(lm(rich~rich.neutral.mean,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),]))

# Mid Domain

par(op)
plot(rich~rich.MidD.mean,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],col=NULL,bg=2,pch=21)
abline(lm(rich~rich.MidD.mean,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),]))

```

### Species Composition

#### Using the raw environmental data as predictors

>Long was excluded for being strongly correlated to Lat

```{r}

vars<-c("Lat2","Long2","conservation","vegetation",paste("bio",1:19,sep=""),"PCA.wclim.1","PCA.wclim.2")

par(mgp=c(.2,0,0))
par(mar=c(2,2,0,0))
par(mfrow=c(ceiling(length(vars)/ceiling(sqrt(length(vars)))),ceiling(sqrt(length(vars)))))

for (i in vars){
  plot(as.formula(paste("pcoa.jac.1~",i)),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range"),axes=FALSE)
  abline(lm(as.formula(paste("pcoa.jac.1~",i)),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")),lwd=2,col=4)
  abline(lm(as.formula(paste("pcoa.logis.jac.",i,".1~",i,sep="")),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")),lwd=2,col=2)
  points(decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),i],"range"),decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),paste("pcoa.logis.jac.",i,".1",sep="")],"range"),pch=21,bg=2,col=0)
  box()
  #abline(lm(as.formula(paste("rich~",i)),data=environment.AF.2d))
  }



summary(step(lm(pcoa.jac.1~.,data=environment.AF.2d[,c("pcoa.jac.1","Lat2","conservation","vegetation","PCA.wclim.1","PCA.wclim.2")])))


#summary(step(lm(pcoa.jac.1~.,data=environment.AF.2d[,c("pcoa.jac.1",paste("pcoa.logis.jac.",paste(c("PCA.wclim.1","PCA.wclim.2"),".1",sep=""),sep=""))])))

#############
# Neutral model

summary(lm(pcoa.jac.1~pcoa.jac.neutral.1,data=environment.AF.2d))

par(op)
plot(pcoa.jac.1~pcoa.jac.neutral.1,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),])

abline(lm(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),"pcoa.jac.1"]~environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),"pcoa.jac.neutral.1"]),lwd=2,col=4)

#colnames(environment.AF.2d)

par(op)

#################
# Mid-Domain

par(op)

summary(lm(pcoa.jac.1~pcoa.MidD.jac.1,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),]))

plot(pcoa.jac.1~pcoa.MidD.jac.1,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),])

abline(lm(pcoa.jac.1~pcoa.MidD.jac.1,data=environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),]),lwd=2,col=2)


```



# Comparison of the observed and predicted by the models

```{r }

par(mfrow=c(1,3))

plot(0:1,0:1,type="n",xlab="Predicted",ylab="Observed")

abline(0,1,lwd=2,lty=2)

title("Richness")

abline(lm(rich~rich.neutral.mean,data=decostand(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],"range")),lwd=2,col=4)

abline(lm(rich~rich.MidD.mean,data=decostand(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],"range")),lwd=2,col=2)

vars<-c("conservation","PCA.wclim.1","PCA.wclim.2")

#for (i in vars){
  
#var.model<-lm(as.formula(paste("rich~",i)),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range"))

#abline(lm(rich~predict(var.model),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")))

#abline(lm(as.formula(paste("rich~",paste("rich.logis.",i,sep=""))),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")),lwd=2,col=6)
#}


# Species composition (PCA)

plot(0:1,0:1,type="n",xlab="Predicted",ylab="Observed")
abline(0,1,lwd=2,lty=2)

title("Species composition (PCA)")

abline(lm(pcoa.jac.1~pcoa.jac.neutral.1,data=decostand(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],"range")),col=4)

#points(rich~rich.MidD.mean,data=decostand(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],"range"),pch=21,bg=2)
abline(lm(pcoa.jac.1~pcoa.MidD.jac.1,data=decostand(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],"range")),col=2)

#vars<-c("Lat2","Long2","conservation","vegetation",paste("bio",1:19,sep=""),"PCA.wclim.1","PCA.wclim.2")

#vars<-c("vegetation","PCA.wclim.1","PCA.wclim.2")

#for (i in vars){
#abline(lm(as.formula(paste("pcoa.jac.1~",i)),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")),lwd=2,col=3)
#abline(lm(as.formula(paste("pcoa.jac.1~",paste("pcoa.logis.jac.",i,".1",sep=""))),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")),lwd=2,col=6)
#}


#Species composition (Jaccard index )

plot(0:1,0:1,type="n",xlab="Predicted",ylab="Observed")

abline(0,1,lwd=2,lty=2)

title("Species composition (Jaccard)")

#points(1-as.dist(morisita.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d]),similarity.jac,col=4)

#library(vegan)

points(1-decostand(as.vector(as.dist(morisita.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d])),"range")
,decostand(as.vector(similarity.jac),"range"),col=4)

#points(similarity.jac~as.dist(similarity.MidD.mean),col=2)

points(decostand(as.vector(as.dist(similarity.MidD.mean)),"range")
,decostand(as.vector(similarity.jac),"range"),col=2)

#summary(lm(similarity.jac~1-as.dist(morisita.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d])))

#summary(lm(similarity.jac~as.dist(similarity.MidD.mean)))

#points(as.dist(similarity.neutral.jac.mean),similarity.jac,col=4)

#points(as.dist(similarity.MidD.mean),similarity.jac,col=2)

#abline(lm(similarity.jac~as.dist(1-similarity.neutral.jac.mean)),col=4)

abline(lm(decostand(as.vector(similarity.jac),"range")~decostand(-as.vector(as.dist(morisita.AF.2d[environment.2d$matchin.AF.2d,environment.2d$matchin.AF.2d])),"range"))
,col=4)


#points(rich~rich.MidD.mean,data=decostand(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],"range"),pch=21,bg=2)
abline(lm(pcoa.jac.1~pcoa.MidD.jac.1,data=decostand(environment.AF.2d[!is.na(environment.AF.2d[,"rich"]),],"range")),col=2)

#points(similarity.jac~as.dist(similarity.MidD.mean),col=2)

#points(decostand(as.vector(as.dist(similarity.MidD.mean)),"range"),decostand(as.vector(similarity.jac),"range"),col=2)


#vars<-c("Lat2","Long2","conservation","vegetation",paste("bio",1:19,sep=""),"PCA.wclim.1","PCA.wclim.2")

#vars<-c("vegetation","PCA.wclim.1","PCA.wclim.2")

#for (i in vars){
#abline(lm(as.formula(paste("pcoa.jac.1~",i)),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")),lwd=2,col=3)
#abline(lm(as.formula(paste("pcoa.jac.1~",paste("pcoa.logis.jac.",i,".1",sep=""))),data=decostand(environment.AF.2d[!is.na(environment.AF.2d$bio19),],"range")),lwd=2,col=6)
#}

```


Compare the models using the statistics in Gotelli et al. (2009)

Mean Square Error (MSE = Bias + Variance)

Richness

```{r}

O<-decostand(environment.2d[!is.na(environment.2d[,"rich"]),"rich"],"standardize")

S<-decostand(rich.MidD.vec,"standardize")
E<-rowMeans(S)

s.bias.sq.MidD<-sum((O-E)^2)
s.var.MidD<-(sum(colSums((S-E)^2)))/(ncol(S)-1)
s.mse.MidD = s.bias.sq.MidD + s.var.MidD

S<-decostand(rich.neutral[!is.na(environment.AF.2d[,"rich"]),],"standardize")
E<-rowMeans(S)

s.bias.sq.neutral<-sum((O-E)^2)
s.var.neutral<-(sum(colSums((S-E)^2)))/(ncol(S)-1)
s.mse.neutral = s.bias.sq.neutral + s.var.neutral

s.bias.sq.logis<-{}
s.var.logis<-{}
s.mse.logis = {}

for (i in glm.variables.2d){ 

S<- decostand(do.call(cbind,lapply(species.2d.logis.ls[[i]],rowSums)),"standardize")

E<-rowMeans(S)

s.bias.sq.logis[i]<-sum((O-E)^2)
s.var.logis[i]<-(sum(colSums((S-E)^2)))/(ncol(S)-1)
s.mse.logis[i] = s.bias.sq.logis[i] + s.var.logis[i]

}

data.frame(BIASsq=c(MidD=s.bias.sq.MidD,Neutral=s.bias.sq.neutral,s.bias.sq.logis),
VAR=c(MidD=s.var.MidD,Neutral=s.var.neutral,s.var.logis),
sMSE=c(MidD=s.mse.MidD,Neutral=s.mse.neutral,s.mse.logis))

```

Similarity

```{r}

O<-decostand(as.vector(as.matrix(similarity.jac)),"standardize")

S<-decostand(similarity.MidD.vec,"standardize")
E<-rowMeans(S)

s.bias.sq.MidD.jac<-sum((O-E)^2)
s.var.MidD.jac<-(sum(colSums((S-E)^2)))/(ncol(S)-1)
s.mse.MidD.jac = s.bias.sq.MidD.jac + s.var.MidD.jac

S<-decostand(apply(similarity.neutral.jac,3,as.vector),"standardize")
E<-rowMeans(S)


s.bias.sq.neu.jac<-sum((O-E)^2)
s.var.neu.jac<-(sum(colSums((S-E)^2)))/(ncol(S)-1)
s.mse.neu.jac <- s.bias.sq.neu.jac + s.var.neu.jac

s.bias.sq.logis.jac<-{}
s.var.logis.jac<-{}
s.mse.logis.jac<- {}

for (i in glm.variables.2d){ 

S<-decostand(apply(similarity.logis.jac.ls[[i]],3,as.vector),"standardize")
E<-rowMeans(S)

s.bias.sq.logis.jac[i]<-sum((O-E)^2)
s.var.logis.jac[i]<-(sum(colSums((S-E)^2)))/(ncol(S)-1)
s.mse.logis.jac[i] = s.bias.sq.logis.jac[i] + s.var.logis.jac[i]

}

data.frame(BIASsq=c(MidD=s.bias.sq.MidD.jac,Neutral=s.bias.sq.neu.jac,s.bias.sq.logis.jac),
VAR=c(MidD=s.var.MidD.jac,Neutral=s.var.neu.jac,s.var.logis.jac),
sMSE=c(MidD=s.mse.MidD.jac,Neutral=s.mse.neu.jac,s.mse.logis.jac))

```



```{r detach_data}

detach(mammal.data)

```


```{r extracting_R_chunks}


purl("All_analysis.Rmd")

```


```{r knit2html, echo=FALSE, eval=FALSE}

library(knitr)

knit2html("All_analysis.Rmd")

```
